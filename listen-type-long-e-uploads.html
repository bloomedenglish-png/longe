<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Listen & Type — Long E (Your Audio)</title>
  <style>
    :root{ --bg:#f7f7f8; --panel:#fff; --ink:#111827; --muted:#6b7280;
           --ok:#16a34a; --bad:#dc2626; --focus:#3b82f6; --border:#e5e7eb; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .wrap{ width:min(900px,100%) }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:16px;
            box-shadow:0 6px 20px rgba(0,0,0,.06); padding:28px; }
    h1{ margin:0 0 6px; font-size:clamp(20px,3.2vw,28px) }
    p.lead{ margin:0 0 10px; color:#6b7280 }
    .meta{ display:flex; gap:12px; align-items:center; color:#6b7280; margin:8px 0 0; flex-wrap:wrap }
    .badge{ background:#eef2ff; border:1px solid var(--border); padding:4px 8px; border-radius:999px; font-weight:700; font-size:13px; color:#3730a3 }
    .qbox{ margin:14px 0 6px; padding:16px; background:#fafafa; border:1px solid var(--border); border-radius:12px }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px }
    .btn{ padding:10px 14px; border:1px solid var(--border); background:#fff; border-radius:10px; cursor:pointer; font-weight:600 }
    .btn:hover{ filter:brightness(.98) }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    input[type="text"]{ font-size:18px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; width:min(260px,100%) }
    .msg{ min-height:1.5em; font-weight:700; margin:8px 0 0 }
    .msg.ok{ color:var(--ok) }
    .msg.bad{ color:var(--bad) }
    footer{ display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px; color:#6b7280; margin-top:14px }
    .score{ font-weight:800; color:var(--ink) }
    .sr-only{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden }
    .hint{ font-size:13px; color:#6b7280; margin-top:6px }
    .note{ font-size:13px; color:#6b7280; margin-top:8px }
    code{ background:#f3f4f6; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
<main class="wrap">
  <section class="card" role="region" aria-labelledby="t">
    <h1 id="t">Listen & Type — Long E (Your Audio)</h1>
    <p class="lead">Click <strong>Play</strong> to hear your recording. Type the word, then press <em>Check</em>.
      This build includes every uploaded audio and guarantees both <em>week</em> and <em>weak</em> appear.</p>
    <p class='note'>Missing audio not included: street, seat.</p>
    <div class="meta">
      <span class="badge" id="qnum">Q 1/N</span>
      <span class="badge" id="progress">0 correct</span>
      <span class="badge" id="audioStatus">Audio: ready</span>
    </div>

    <div class="qbox">
      <div class="controls" aria-label="Audio controls">
        <button id="play" class="btn" type="button">▶ Play</button>
        <button id="slow" class="btn" type="button">▶ Slow</button>
        <button id="repeat3" class="btn" type="button">↻ x3</button>
        <audio id="player" preload="auto"></audio>
      </div>
      <div class="controls" aria-label="Answer input">
        <label class="sr-only" for="answer">Type the word you heard</label>
        <input id="answer" type="text" placeholder="Type what you hear" autocomplete="off" />
        <button id="check" class="btn" type="button">Check</button>
        <button id="next" class="btn" type="button" disabled>Next</button>
        <button id="restart" class="btn" type="button">Restart</button>
      </div>
      <div id="feedback" class="msg" aria-live="polite" aria-atomic="true"></div>
      <div id="hint" class="hint" aria-live="polite" aria-atomic="true"></div>
    </div>

    <footer>
      <div class="score" aria-live="polite" aria-atomic="true">Score: <span id="score">0/N</span></div>
    </footer>
  </section>
</main>

<script>
  const ITEMS = [{"word": "be", "src": "be.wav"}, {"word": "we", "src": "we.wav"}, {"word": "she", "src": "she.wav"}, {"word": "he", "src": "he.wav"}, {"word": "me", "src": "me.wav"}, {"word": "teach", "src": "teach.wav"}, {"word": "easy", "src": "easy.wav"}, {"word": "leave", "src": "leave.wav"}, {"word": "read", "src": "read.wav"}, {"word": "team", "src": "team.wav"}, {"word": "each", "src": "each.wav"}, {"word": "eat", "src": "eat.wav"}, {"word": "weak", "src": "weak.wav", "hint": "Hint: homophones — 'week' = 7 days; 'weak' = not strong."}, {"word": "week", "src": "week.wav", "hint": "Hint: homophones — 'week' = 7 days; 'weak' = not strong."}, {"word": "sleep", "src": "sleep.wav"}, {"word": "meet", "src": "meet.wav"}, {"word": "free", "src": "free.wav"}, {"word": "feel", "src": "feel.wav"}, {"word": "keep", "src": "keep.wav"}];

  // Prefer 20 questions; if fewer files, use all. Ensure both week & weak included.
  const TARGET = Math.min(20, ITEMS.length);

  let order = [];
  let currentIndex = 0;
  let score = 0;

  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }

  function buildOrder(){
    const arr = [...ITEMS];
    const must = [];
    for(const w of ['week','weak']){
      const i = arr.findIndex(x => x.word === w);
      if(i >= 0) must.push(arr.splice(i,1)[0]);
    }
    shuffle(arr);
    order = [...must, ...arr].slice(0, TARGET);
    currentIndex = 0;
    score = 0;
    updateHUD();
  }

  function updateHUD(){
    document.getElementById('qnum').textContent = "Q " + (currentIndex+1) + "/" + order.length;
    document.getElementById('score').textContent = score + "/" + order.length;
    document.getElementById('progress').textContent = score + " correct";
  }

  function current(){ return order[currentIndex]; }

  function loadAudio(){
    const audio = document.getElementById('player');
    audio.src = current().src;
    audio.load();
  }

  function renderQuestion(){
    document.getElementById('answer').value = "";
    document.getElementById('feedback').textContent = "Press Play, listen, then type the word.";
    document.getElementById('feedback').className = "msg";
    document.getElementById('hint').textContent = current().hint || "";
    document.getElementById('next').disabled = true;
    document.getElementById('check').disabled = false;
    loadAudio();
    updateHUD();
    setTimeout(()=>{
      const audio = document.getElementById('player');
      audio.play().catch(()=>{{ document.getElementById('audioStatus').textContent = "Audio: click Play"; }});
    }, 350);
  }

  document.getElementById('play').addEventListener('click', ()=>{
    const a = document.getElementById('player'); a.playbackRate=1.0; a.currentTime=0; a.play();
  });
  document.getElementById('slow').addEventListener('click', ()=>{
    const a = document.getElementById('player'); a.playbackRate=0.85; a.currentTime=0; a.play();
  });
  document.getElementById('repeat3').addEventListener('click', ()=>{
    const a = document.getElementById('player'); let n=0;
    function again(){ if(n++>=3) return; a.playbackRate=0.95; a.currentTime=0; a.play().then(()=>{ setTimeout(again, Math.max(800,(a.duration||1)*1000+300)); }).catch(()=>{ document.getElementById('audioStatus').textContent = "Audio: click Play"; }); }
    again();
  });

  document.getElementById('check').addEventListener('click', ()=>{
    const guess = document.getElementById('answer').value.trim().toLowerCase();
    const correct = current().word.toLowerCase();
    const fb = document.getElementById('feedback');
    if(guess === correct){
      fb.textContent = "Correct! " + current().word;
      fb.className = "msg ok";
      score++;
      document.getElementById('next').disabled = false;
      document.getElementById('check').disabled = true;
    }else{
      fb.textContent = "Not yet. Listen again and try.";
      fb.className = "msg bad";
    }
    updateHUD();
  });

  document.getElementById('next').addEventListener('click', ()=>{
    if(currentIndex < order.length-1){ currentIndex++; renderQuestion(); }
    else{
      const fb = document.getElementById('feedback');
      fb.textContent = "All done! You scored " + score + "/" + order.length + ".";
      fb.className = "msg ok";
      document.getElementById('check').disabled = true;
      document.getElementById('next').disabled = true;
    }
  });

  document.getElementById('restart').addEventListener('click', ()=>{ buildOrder(); renderQuestion(); });

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      const nextDisabled = document.getElementById('next').disabled;
      if(nextDisabled) document.getElementById('check').click();
      else document.getElementById('next').click();
    }
  });

  buildOrder();
  renderQuestion();
</script>
</body>
</html>
